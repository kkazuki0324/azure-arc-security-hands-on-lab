# モジュール 1: 環境のセットアップと前提条件の確認

このモジュールでは、ハンズオンラボを開始するための環境セットアップと前提条件を確認します。

## 目標

- Azure サブスクリプションの確認
- 必要な Azure リソースプロバイダーの登録
- オンプレミス環境のセットアップ（2つの選択肢）
  - オプション A: Azure VM を使用したシミュレーション環境
  - オプション B: 実際のオンプレミス仮想マシンの使用

## 課金に関する注意事項

このハンズオンラボでは、以下のAzureリソースを使用します。これらのリソースには費用が発生します：

- **Windows Server 仮想マシン** (Standard_D2s_v3): 約¥100～150/時間
[Azure Virtual Machine 価格](https://azure.microsoft.com/ja-jp/pricing/details/virtual-machines/windows/?msockid=300b641468f0694b2ee6716469a968e1)
- **Microsoft Defender for Servers**: 約¥10-12/サーバー/日（Plan 2）
[Microsoft Defender for Servers 価格](https://azure.microsoft.com/ja-jp/pricing/details/defender-for-cloud/?msockid=300b641468f0694b2ee6716469a968e1)
- **Azure Sentinel / Log Analytics**: 約¥250/GB（データ取り込み）
[Microsoft Sentinel 価格](https://www.microsoft.com/ja-jp/security/pricing/microsoft-sentinel/?msockid=300b641468f0694b2ee6716469a968e1)

**コスト削減のポイント**:
- ラボが完了したら、すぐにリソースをクリーンアップしてください
- VM作成時に自動シャットダウンを設定してください
- 不要な時間帯はVMを停止状態にしてください

詳しい料金情報については、[Azure料金計算ツール](https://azure.microsoft.com/ja-jp/pricing/calculator/)を参照してください。

## タスク 1: Azure サブスクリプションの確認

1. [Azure ポータル](https://portal.azure.com)にサインインします。
2. 右上のアカウントアイコンをクリックし、使用するサブスクリプションが選択されていることを確認します。
3. 必要に応じて、適切なサブスクリプションに切り替えます。

![Azure サブスクリプションの確認](../../images/module1/subscription-check.png)

## タスク 2: 必要な Azure リソースプロバイダーの登録

このハンズオンラボで必要なリソースプロバイダーを登録します。

1. Azure ポータルの検索バーで「**サブスクリプション**」と入力し、表示されるサービスをクリックします。
2. 使用するサブスクリプションをクリックします。
3. 左側のメニューから「**リソースプロバイダー**」をクリックします。
4. 検索バーに「**Microsoft.HybridCompute**」と入力し、表示されたリソースプロバイダーが「登録済み」でない場合は、選択して「**登録**」をクリックします。
5. 同様に、以下のリソースプロバイダーも登録されていることを確認します：
   - Microsoft.GuestConfiguration
   - Microsoft.HybridConnectivity
   - Microsoft.Security
   - Microsoft.SecurityInsights

![リソースプロバイダーの登録](../../images/module1/resource-providers.png)

## タスク 3: オンプレミス環境のセットアップ

このラボでは、以下の2つの方法からお好みの方法を選択できます：
- **オプション A**: Azure VM を使用してオンプレミス環境をシミュレーション（推奨）
- **オプション B**: 実際のオンプレミス仮想マシンを使用

### オプション A: Azure VM を使用したシミュレーション環境のセットアップ

このオプションでは、Azure VM を使用してオンプレミス環境をシミュレーションします。

1. Azure ポータルの検索バーで「**仮想マシン**」と入力し、表示されるサービスをクリックします。
2. 「**作成**」→「**Azure 仮想マシン**」をクリックします。
3. 以下の設定で仮想マシンを構成します：

   - **サブスクリプション**: ご使用のサブスクリプション
   - **リソースグループ**: 新規作成「ArcLab-RG」
   - **仮想マシン名**: OnPremServer
   - **地域**: お近くのリージョン
   - **可用性オプション**: インフラストラクチャ冗長は必要ありません
   - **セキュリティの種類**: Standard
   - **イメージ**: Windows Server 2019 Datacenter - x64 Gen2
   - **サイズ**: Standard_D2s_v3（2 vCPU、8 GiB メモリ）または同等
   - **ユーザー名**: arcadmin
   - **パスワード**: 複雑なパスワードを設定し、メモしておいてください
   - **パブリック受信ポート**: 選択したポートを許可する
   - **受信ポートを選択**: RDP (3389)

4. 「**ネットワーク**」タブで、以下を確認します：
   - 新規の仮想ネットワークが作成されること
   - パブリック IP が割り当てられること

5. 「**管理**」タブで、以下を設定します：
   - **自動シャットダウン**: 有効
   - **シャットダウン時刻**: ラボ終了予定時刻

6. 「**確認および作成**」をクリックし、検証が完了したら「**作成**」をクリックします。

7. デプロイが完了するまで待ちます（約 5 分程度）。

#### Lab VM への接続とセットアップ

1. デプロイが完了したら、仮想マシン「OnPremServer」の概要ページに移動します。
2. 「**接続**」→「**RDP**」をクリックします。
3. 「**RDP ファイルのダウンロード**」をクリックし、ダウンロードしたファイルを開きます。
4. 接続先の身元を確認するダイアログが表示されたら、「**接続**」をクリックします。
5. ユーザー名（arcadmin）とパスワードを入力してサインインします。
6. サーバーマネージャーが自動的に起動したら、「**ローカルサーバー**」をクリックします。
7. 「**IE セキュリティ強化の構成**」の設定で「**オフ**」をクリックします（管理者のみ）。

### オプション B: 実際のオンプレミス仮想マシンの使用

このオプションでは、お手元の環境にある Windows Server マシンを使用します。

#### 前提条件

- Windows Server 2016/2019/2022 がインストールされた仮想マシンまたは物理サーバー
- 管理者権限を持つアカウント
- インターネット接続
- ファイアウォールで以下のポートが開放されていること:
  - TCP 443 (HTTPS)
  - TCP 445 (SMB)

#### オンプレミスサーバーの準備

1. Windows Server マシンに管理者としてログインします。
2. サーバーマネージャーを開き、「**ローカルサーバー**」をクリックします。
3. 「**IE セキュリティ強化の構成**」の設定で「**オフ**」をクリックします（管理者のみ）。
4. Windows Defender ファイアウォールで、必要なポート（TCP 443, 445）が開放されていることを確認します。

## タスク 4: PowerShell 実行ポリシーの設定

どちらのオプションを選択した場合も、以下の手順でPowerShell実行ポリシーを設定します。

1. スタートメニューを右クリックし、「**Windows PowerShell (管理者)**」を選択します。
2. 次のコマンドを実行して、PowerShell の実行ポリシーを変更します：

```powershell
Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
```

## 次のステップ

これで環境のセットアップが完了しました。次のモジュールでは、Azure Arc を使用してオンプレミスサーバーをオンボーディングします。

[モジュール 2: Azure Arc でのサーバーオンボーディング](../module2/README.md)に進みます。

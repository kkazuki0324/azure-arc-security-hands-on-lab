# モジュール 3: Microsoft Defender for Servers の有効化と構成

このモジュールでは、Azure Arc に接続したサーバーに Microsoft Defender for Servers を有効化し、構成します。

## 目標

- Microsoft Defender for Cloud を有効化する
- Azure Arc 接続サーバーに Defender for Servers を有効化する
- Defender プランの機能を確認する
- 脆弱性評価を設定する

## Defender for Servers の料金に関する注意事項

Microsoft Defender for Servers には以下のプランがあります：

1. **Plan 1（基本機能）**: 約 ¥4-5/サーバー/日

   - 脅威検出と対応の基本機能
   - セキュリティベースラインの評価

2. **Plan 2（高度な機能）**: 約 ¥10-12/サーバー/日
   - Plan 1 のすべての機能
   - 脆弱性評価
   - ファイルの整合性モニタリング
   - 適応型アプリケーション制御
   - 適応型ネットワーク強化

このラボでは **Plan 2** を使用します。ラボの所要時間（約 4-5 時間）で発生する料金は、サーバー 1 台あたり約 ¥50 前後の見込みです。

> **注意**: 上記の価格は概算であり、実際の料金は契約内容によって異なる場合があります。

## タスク 1: Microsoft Defender for Cloud を有効化する

1. [Azure ポータル](https://portal.azure.com)にサインインします。
2. 検索バーに「**Microsoft Defender for Cloud**」と入力し、表示されるサービスをクリックします。
3. 初めて利用する場合は、ウェルカムページが表示されます。「**アップグレード**」をクリックします。
4. 「**管理**」セクションから「**環境設定**」をクリックします。
5. サブスクリプションを選択します。
6. 「**Defender プラン**」タブをクリックします。
7. 「**設定と監視**」セクションで、「**Defender for Servers プラン 2**」を選択します。
8. 「**保存**」をクリックします。

![Defender プランの有効化](../../images/module3/defender-plans.png)

## タスク 2: Azure Arc 接続サーバーへの Defender エージェントのインストール

1. Microsoft Defender for Cloud の左側のメニューから「**インベントリ**」をクリックします。
2. フィルタを設定して「リソースの種類」→「マシン - Azure Arc」を選択します。
3. 前のモジュールで接続した「OnPremServer」を見つけて選択します。
4. 上部にある「**Defender エージェントのインストール**」をクリックします。
5. 表示される確認ダイアログで「**インストール**」をクリックします。
6. インストールが完了するまで待ちます（約 5-10 分程度）。

## タスク 3: Defender エージェントのインストール状態の確認

1. Azure ポータルで「**Azure Arc**」→「**マシン - Azure Arc**」に移動します。
2. 「OnPremServer」をクリックします。
3. 左側のメニューから「**拡張機能**」をクリックします。
4. 次の拡張機能がインストールされていることを確認します：
   - Azure Monitor エージェント
   - Microsoft Defender for Cloud エージェント

![Defender エージェントの確認](../../images/module3/defender-extensions.png)

## タスク 4: 脆弱性評価の設定

Microsoft Defender for Servers Plan 2 には、脆弱性評価スキャナーが含まれています。これを設定します。

1. Microsoft Defender for Cloud の左側のメニューから「**環境設定**」をクリックします。
2. サブスクリプションを選択します。
3. 「**設定と監視**」セクションから「**脆弱性評価**」をクリックします。
4. 「**マシンの脆弱性評価**」が有効になっていることを確認します。
5. 「**Microsoft 脆弱性評価**」が選択されていることを確認します。
6. 「**保存**」をクリックします。

## タスク 5: Defender for Servers のコンプライアンス状態の確認

1. Microsoft Defender for Cloud の左側のメニューから「**インベントリ**」をクリックします。
2. リソースのフィルタを設定して「マシン - Azure Arc」を選択します。
3. 「OnPremServer」を確認し、「コンプライアンス」の状態を確認します。

   - 注意: 初期セットアップ後、評価が完了するまでに数時間かかることがあります。

4. サーバーをクリックして詳細ページを開きます。
5. 「**セキュリティの推奨事項**」タブを確認します。これらの推奨事項は、時間と共に更新されます。

## タスク 6: セキュリティ設定の確認

1. Microsoft Defender for Cloud の左側のメニューから「**推奨事項**」をクリックします。
2. フィルタを設定して「リソースの種類」→「マシン - Azure Arc」を選択します。
3. さまざまなセキュリティ推奨事項が表示されます。いくつかの推奨事項を展開して詳細を確認します。

## 次のステップ

これで、Azure Arc に接続したサーバーに Microsoft Defender for Servers が正常に有効化されました。次のモジュールでは、テスト攻撃シナリオを実施して、セキュリティイベントを生成します。

[モジュール 4: テスト攻撃シナリオの実施](../module4/README.md)に進みます。

# モジュール 5: Azure Sentinel でのインシデント対応

このモジュールでは、Microsoft Defender for Servers から生成されたアラートを Azure Sentinel に集約し、インシデント対応プロセスを実施します。

## 目標

- Azure Sentinel ワークスペースを作成する
- Microsoft Defender for Cloud とのデータ接続を設定する
- インシデントを調査する
- インシデント対応のプロセスを実施する

## タスク 1: Azure Sentinel ワークスペースの作成

1. [Azure ポータル](https://portal.azure.com)にサインインします。
2. 検索バーに「**Log Analytics ワークスペース**」と入力し、表示されるサービスをクリックします。
3. 「**作成**」をクリックします。
4. 以下の設定を入力します：
   - **サブスクリプション**: ご使用のサブスクリプション
   - **リソースグループ**: 新規作成「ArcSentinel-RG」
   - **名前**: ArcSecurityWorkspace
   - **地域**: お近くのリージョン
5. 「**確認および作成**」をクリックし、検証が完了したら「**作成**」をクリックします。
6. デプロイが完了するまで待ちます。

## タスク 2: Azure Sentinel の有効化

1. Azure ポータルの検索バーに「**Microsoft Sentinel**」と入力し、表示されるサービスをクリックします。
2. 「**Microsoft Sentinel の作成**」をクリックします。
3. 先ほど作成した「ArcSecurityWorkspace」を選択し、「**追加**」をクリックします。

## タスク 3: Microsoft Defender for Cloud とのデータ接続の設定

1. 作成した Microsoft Sentinel ワークスペースの左側のメニューから「**データコネクタ**」をクリックします。
2. コネクタのリストから「**Microsoft Defender for Cloud**」を検索し、選択します。
3. コネクタの詳細ページで「**コネクタページを開く**」をクリックします。
4. 「**サブスクリプション**」タブで、使用しているサブスクリプションを選択します。
5. 「**接続**」をクリックします。
6. 接続が完了したら、「**閉じる**」をクリックします。

![Defender コネクタの設定](../../images/module5/defender-connector.png)

## タスク 4: 分析ルールテンプレートの有効化

1. Microsoft Sentinel の左側のメニューから「**分析**」をクリックします。
2. 「**ルールテンプレート**」タブをクリックします。
3. 検索バーに「**Defender**」と入力して、関連するテンプレートをフィルタリングします。
4. 「**Microsoft Defender for Cloud アラートの作成**」というテンプレートを見つけ、選択します。
5. 表示される詳細ペインで「**ルールの作成**」をクリックします。
6. デフォルト設定を確認し、「**次へ: 自動応答**」をクリックします。
7. 自動応答の設定は、このラボではスキップします。「**次へ: 確認**」をクリックします。
8. 「**作成**」をクリックして分析ルールを作成します。

## タスク 5: インシデントの確認と調査

1. Microsoft Sentinel の左側のメニューから「**インシデント**」をクリックします。
2. しばらく待ちます（30 分程度）。前のモジュールで生成したセキュリティアラートに基づくインシデントが表示されるはずです。
3. インシデントのリストから、興味のあるインシデントを選択します。
4. 「**インシデントの詳細**」ペインで、重要度、ステータス、関連するエンティティなどの情報を確認します。
5. 「**調査**」ボタンをクリックして、インシデント調査ページを開きます。

![インシデントの調査](../../images/module5/incident-investigation.png)

## タスク 6: インシデント対応の実施

1. インシデントの詳細ページで、「**詳細**」タブを確認します。
2. 「**エンティティ**」タブをクリックして、関連するホスト、アカウント、プロセスなどを確認します。
3. 「**タイムライン**」タブをクリックして、イベントの時間的順序を確認します。
4. インシデントのステータスを「**アクティブ**」に変更し、所有者を自分に割り当てます。
5. 「**コメント**」セクションに、インシデントに関する注記を追加します：

```
テスト攻撃シナリオによるインシデント。Mimikatdz のシミュレーションによるアラートを確認。調査を開始します。
```

6. 「**タグ**」セクションで、「**追加**」をクリックし、「TestIncident」というタグを追加します。

## タスク 7: インシデントの修復

1. 調査結果に基づいて、以下の修復アクションを実施するとします（シミュレーションのため、実際には実行しません）：

   - 影響を受けたシステムの分離
   - マルウェアの削除
   - ユーザーアカウントのリセット
   - セキュリティポリシーの強化

2. インシデントの詳細ページに戻り、ステータスを「**クローズ**」に変更します。
3. 「**分類**」を「**True Positive - 疑わしいアクティビティ**」に設定します。
4. 「**コメント**」セクションに、クロージングノートを追加します：

```
このインシデントはラボ環境でのテスト攻撃シナリオによるものです。実際の環境では、影響を受けたシステムの分離、マルウェアの削除、アカウントのリセット、セキュリティポリシーの強化などの修復アクションが必要となります。
```

5. 「**保存**」をクリックします。

## 次のステップ

これで、Azure Sentinel を使用したインシデント対応プロセスが完了しました。次のモジュールでは、ラボ環境のクリーンアップを行い、今後のステップについて説明します。

[モジュール 6: クリーンアップと次のステップ](../module6/README.md)に進みます。
